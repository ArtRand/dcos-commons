name: {{FRAMEWORK_NAME}}
web-url: http://rethinkdb-0-server.rethinkdb.mesos:4040
pods:
  rethinkdb:
    # we run this as the hub of the service, it hosts the web UI and all of the others bind to it, so we only need 1
    count: 1
    #placement: {{PLACEMENT_CONSTRAINTS}}
    container:
      image-name: centos
    uris:
      - "https://download.rethinkdb.com/centos/6/x86_64/rethinkdb.repo"
    tasks:
      server:
        goal: RUNNING
        cmd: >
          cp rethinkdb.repo /etc/yum.repos.d/ &&
          yum -y install rethinkdb &&
          rethinkdb --bind all --http-port 4041 --cluster-port 4001 --driver-port 4021 -d rethinkdb_hub -c {{RETHINKDB_CPUS}}
        cpus: {{RETHINKDB_CPUS}}
        ports:
          intercluster:
            env-key: INTER_CLUSTER
            port: 4001
          driverport:
            env-key: DRIVER_PORT
            port: 4021
            vip:
              prefix: server-lb
              port: 80
          httpd:
            env-key: PORT_HTTPD
            port: 4041
        memory: {{RETHINKDB_MEM}}
        volume:
          path: "rethinkdb-container-path"
          type: ROOT
          size: {{RETHINKDB_DISK}}
  rethinkdbnode:
    count: {{RETHINKDB_COUNT}}
    container:
      image-name: centos
    uris:
      - "https://download.rethinkdb.com/centos/6/x86_64/rethinkdb.repo"
    tasks:
      server:
        goal: RUNNING
        cmd: >
          cp rethinkdb.repo /etc/yum.repos.d/ &&
          yum -y install rethinkdb &&
          rethinkdb --port-offset $POD_INSTANCE_INDEX --join rethinkdb-0-server.rethinkdb.mesos:4001 -d rethinkdb_$POD_INSTANCE_INDEX -c {{RETHINKDB_CPUS}}
        cpus: {{RETHINKDB_CPUS}}
        memory: {{RETHINKDB_MEM}}
        volume:
          path: "rethinkdb-container-path"
          type: ROOT
          size: {{RETHINKDB_DISK}}
  proxylite:
    container:
      image-name: mesosphere/proxylite:1.0.1
    count: 1
    tasks:
      server:
        goal: RUNNING
        cmd: "/proxylite/run.sh"
        cpus: 1
        memory: 256
        ports:
          proxylite:
            env-key: PORT_PROXYLITE
            port: 4040
        env:
          ROOT_REDIRECT: "/httpd"
          EXTERNAL_ROUTES: "/v1,/httpd"
          INTERNAL_ROUTES: "rethinkdb.marathon.mesos:{{PORT0}}/v1,rethinkdb-0-server.rethinkdb.mesos:4041"

plans:
  deploy:
    strategy: serial
    # it is recommended that you name the phases with the suffix -phase
    phases:
      hub-phase:
        strategy: serial
        pod: rethinkdb
      proxylite-phase:
        strategy: serial
        pod: proxylite
      rethinkdbnode-phase:
        strategy: parallel
        pod: rethinkdbnode
